---
title: "Optimizing Scooter Deployments in Fort Collins"
author: "Group 4"
date: "2024"
output: 
  ioslides_presentation:
    widescreen: true
    css: custom.css
---

```{r setup, include=FALSE}
# Set global chunk options
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6)

# Load all required libraries
library(tidyverse)
library(tidymodels)
library(sf)
library(ggplot2)
library(ggmap)
library(RColorBrewer)
library(patchwork)
library(fields)
library(MASS)
library(dbscan)
library(here)
library(kknn)

# Set seed for reproducibility
set.seed(445)
```

## Data Preparation

# SPIN provided spatial data files labeled 'Curb Events': {Deployment, Start, End}
# Raw spatial data (no non-spatial data columns)


```{r load-data, include= FALSE}
#load data sets
start_scoot <- read.csv("FOCO Spin Data/fort-collins-curb-events-2021-07-26-2024-10-15-trip_starts.csv")
end_scoot <- read.csv('FOCO Spin Data/fort-collins-curb-events-2021-07-26-2024-10-15-trip_ends.csv')
dpl_scoot <- read.csv('FOCO Spin Data/fort-collins-curb-events-2021-07-26-2024-10-15-deployments.csv')

#register stadia maps
register_stadiamaps('dd6906c8-64ba-46a6-966a-4a3556ae9e34',write = TRUE)

#set map bounds call stadia map
foco_map_bounds <- c(left = -105.17, bottom = 40.465, right = -104.98, top = 40.64)

foco_map <- get_stadiamap(foco_map_bounds, zoom = 12, maptype = 'stamen_toner_lite')

foco_coord_map <- ggmap(foco_map, extent = 'device', legend = 'none')

#filter data to the map bounds
clean_start_scoot <- start_scoot |>
  filter(!is.na(longitude) & !is.na(latitude)) |>
  filter(
    longitude >= foco_map_bounds["left"],
    longitude <= foco_map_bounds["right"],
    latitude >= foco_map_bounds["bottom"],
    latitude <= foco_map_bounds["top"]
  )
clean_end_scoot <- end_scoot |>
  filter(!is.na(longitude) & !is.na(latitude)) |>
  filter(
    longitude >= foco_map_bounds["left"],
    longitude <= foco_map_bounds["right"],
    latitude >= foco_map_bounds["bottom"],
    latitude <= foco_map_bounds["top"]
  )
clean_dpl_scoot <- dpl_scoot |>
  filter(!is.na(longitude) & !is.na(latitude)) |>
  filter(
    longitude >= foco_map_bounds["left"],
    longitude <= foco_map_bounds["right"],
    latitude >= foco_map_bounds["bottom"],
    latitude <= foco_map_bounds["top"]
  )
```

## Base Map Visualization {.flexbox .vcenter}

```{r base-map}
foco_coord_map
```

## Trip Start Analysis

```{r start-maps, echo = FALSE}
#raw start points
start_map <- foco_coord_map + geom_point(data = clean_start_scoot, aes(x = longitude, y = latitude), alpha = 0.15, size = 0.8, color = 'orange') + theme(panel.grid = element_blank()) + ggtitle('start points')

#density heatmap
start_dens_heatmap <- foco_coord_map + stat_density2d(data= clean_start_scoot,  aes(x=longitude, y=latitude, fill= after_stat(level)), geom="polygon", contour = TRUE, bins = 500, h = c(0.012, 0.012)) + scale_fill_gradientn(colors = rev(brewer.pal(9, 'PuOr')), name = 'Density') + theme(panel.grid = element_blank()) + ggtitle("Scooter Start Density")

#side by side maps
start_dens_heatmap + start_map + plot_layout(ncol = 2, guides = 'collect')
```
## Trip Deployment Analysis

```{r dpl maps, echo = FALSE}
deployment_points <- foco_coord_map + geom_point(data = clean_dpl_scoot, aes(x = longitude, y = latitude), alpha = 0.15, size = 0.8, color = 'orange') + theme(panel.grid = element_blank())
  
deployment_map <- foco_coord_map + stat_density2d(data = clean_dpl_scoot,  aes(x = longitude, y = latitude, fill = after_stat(level)), geom = "polygon", contour = TRUE, bins = 750,h = c(0.012, 0.012)) +
  scale_fill_gradientn(colors = rev(brewer.pal(9, 'PuOr')), name = 'Deployment\nDensity') + 
  theme(panel.grid = element_blank()) + 
  ggtitle("Scooter Deployment Density")

deployment_points + deployment_map + plot_layout(ncol = 2, guides = 'collect')
```

## Raw Start Data Points vs Density {.flexbox .vcenter}

```{r dpl-&-start, echo = FALSE}
deployment_map + start_dens_heatmap  + 
    plot_layout(ncol = 2, guides = 'collect')
```

## KNN Model Analysis {.flexbox .vcenter}

```{r Knn-Models, echo=FALSE}
#set a knn model to compare deployment to start locations to validate that deployments start where they need to.
dpl_knn_model <- nearest_neighbor(neighbors = tune(), weight_func = tune()) |>
  set_engine('kknn') |>
  set_mode('regression')

tuning_grid <- grid_regular(neighbors(range = c(5,25)), weight_func(), levels = c(5,4))

#create grid to count points of data in each grid cell
dpl_dens <- clean_dpl_scoot |>
  mutate(lon_bin = cut_width(longitude, width = 0.005), lat_bin = cut_width(latitude, width = 0.005)) |> 
  group_by(lon_bin, lat_bin) |>
  summarise(n = n(), longitude = mean(longitude), latitude = mean(latitude)) |> 
  mutate(density_score = n/max(n))

#predict density scores using lon + lat
dpl_knn_recipe <- recipe(density_score ~ longitude + latitude, data = dpl_dens)

#c-fold cross validation
cv_folds <- vfold_cv(dpl_dens, v=5)

#knn workflow
dpl_knn_res <- workflow() |>
  add_model(dpl_knn_model) |>
  add_recipe(dpl_knn_recipe) |>
  tune_grid(resamples = cv_folds, grid = tuning_grid)

dpl_best_params <- select_best(dpl_knn_res, metric = 'rmse')

#knn final workflow
dpl_knn_final_fit <- workflow() |>
  add_model(dpl_knn_model) |>
  add_recipe(dpl_knn_recipe) |>
  finalize_workflow(dpl_best_params) |>
  fit(dpl_dens)

#deployment final fit
dpl_knn_final_fit
```

```{r, echo=FALSE}
#set a knn model to compare deployment to start locations to validate that deployments start where they need to.
start_knn_model <- nearest_neighbor(neighbors = tune(), weight_func = tune()) |>
  set_engine('kknn') |>
  set_mode('regression')

tuning_grid <- grid_regular(neighbors(range = c(5,25)), weight_func(), levels = c(5,4))

#create grid to count points of data in each grid cell
start_dens <- clean_start_scoot |>
  mutate(lon_bin = cut_width(longitude, width = 0.005), lat_bin = cut_width(latitude, width = 0.005)) |> 
  group_by(lon_bin, lat_bin) |>
  summarise(n = n(), longitude = mean(longitude), latitude = mean(latitude)) |> 
  mutate(density_score = n/max(n))

#predict density scores using lon + lat
start_knn_recipe <- recipe(density_score ~ longitude + latitude, data = start_dens)

#c-fold cross validation
cv_folds <- vfold_cv(start_dens, v=5)

#knn workflow
start_knn_res <- workflow() |>
  add_model(start_knn_model) |>
  add_recipe(start_knn_recipe) |>
  tune_grid(resamples = cv_folds, grid = tuning_grid)

start_best_params <- select_best(start_knn_res, metric = 'rmse')

#knn final workflow
start_knn_final_fit <- workflow() |>
  add_model(start_knn_model) |>
  add_recipe(start_knn_recipe) |>
  finalize_workflow(start_best_params) |>
  fit(start_dens)

#deployment final fit
start_knn_final_fit
```

## KNN Predictions
```{r pred, include=FALSE}
#comparing model predictions
grid_pts <- expand.grid(longitude = seq(foco_map_bounds['left'], foco_map_bounds['right'], by = 0.001), latitude = seq(foco_map_bounds['bottom'], foco_map_bounds['top'], by = 0.001))

dpl_pred <- predict(dpl_knn_final_fit, grid_pts)
start_pred <- predict(start_knn_final_fit, grid_pts)
```

## Deployment KNN Map
```{r KNN-dpl-map, echo = FALSE}

deployment_predictions <- grid_pts |>
  mutate(density = dpl_pred$.pred)

deployment_knn_map <- foco_coord_map + 
  geom_tile(
    data = deployment_predictions,
    aes(x = longitude, y = latitude, fill = density),
    alpha = 0.8
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    name = "Predicted\nDeployment\nDensity"
  ) +
  ggtitle("KNN Predicted Deployment Density (k=25)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

```

## Deployment & Start KNN Maps
```{r KNN-start-map, echo=FALSE}
start_predictions <- grid_pts |>
  mutate(density = start_pred$.pred)

start_knn_map <- foco_coord_map + 
  geom_tile(
    data = start_predictions,
    aes(x = longitude, y = latitude, fill = density),
    alpha = 0.8
  ) +
  scale_fill_viridis_c(
    option = "plasma",
    name = "Predicted\nStart\nDensity"
  ) +
  ggtitle("KNN Predicted Start Density (k=10)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

```
```{r KNN Density - & - Start, echo = FALSE}
deployment_knn_map + start_knn_map + plot_layout(ncol = 2, guides = 'collect')
```

## Optimization Map (Deployment vs. Start)
```{r optimization - map, echo = FALSE}


comparison <- grid_pts |>
  mutate(dpl_density = dpl_pred$.pred,
         start_density = start_pred$.pred,
         difference = start_density - dpl_density)

foco_coord_map + geom_tile(data = comparison, aes(x=longitude, y = latitude, fill = difference), alpha = .8) + scale_fill_gradient2(low='red',mid='white', high='green', name = 'Deployment vs\nStart Density') + coord_fixed() + theme_minimal()
```

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
#Appendix
```