---
title: "Exploratory_Analysis_Josh_Tobey"
author: "Joshua Tobey"
date: "2025-11-17"
output: html_document
---
```{r}
install.packages(c("usethis", "gitcreds"))
```

```{r}
library(tidyverse)
library(tidymodels)
library(dplyr)
library(knitr)
library(lubridate)

```

```{r}
exploratory_df <- read_csv("RWAR_dosing_cleaned.csv")
colnames(exploratory_df)
```

```{r}
ggplot(exploratory_df) +
  geom_point(aes(x = mean_Turbidity,
                 y = mean_Temp,
                 color = mean_Temp)) +
  scale_color_gradient(low = 'yellow', high = 'green')
```

```{r}
head(exploratory_df)

```
```{r}
summary(exploratory_df)

```

```{r}
exploratory_df$Timestamp = ymd(exploratory_df$Timestamp)
exploratory_df <- exploratory_df[order(exploratory_df$Timestamp), ]
ggplot(exploratory_df, aes(x = Timestamp,
                           y = mean_pH,
                           color = mean_pH)) +
  geom_line() + 
  scale_color_gradient(low = 'blue', high = 'red')

```
```{r}
exploratory_df$Timestamp <- ymd(exploratory_df$Timestamp)
exploratory_df <- exploratory_df[order(exploratory_df$Timestamp), ]
ggplot(exploratory_df, aes(x = Timestamp,
                           y = mean_Temp,
                           color = mean_Temp)) +
  geom_line() + 
  scale_color_gradient(low = 'yellow', high = 'green')

```
```{r}
library(patchwork)
plot1 <- ggplot(exploratory_df, aes(x = Timestamp,
                           y = mean_pH,
                           color = mean_pH)) +
  geom_line() + 
  scale_color_gradient(low = 'blue', high = 'red') +
  theme_minimal() +
  ggtitle("Average pH over Time")

plot2 <- ggplot(exploratory_df, aes(x = Timestamp,
                           y = Cationic.Polimer..mg.L,
                           color = Cationic.Polimer..mg.L)) +
  geom_line() + 
  scale_color_gradient(low = 'yellow', high = 'green') +
  theme_minimal() +
  ggtitle("Polymer Coagulant over Time")

plot1/plot2
```



```{r}
ggplot(exploratory_df) +
  geom_jitter(aes(x = mean_Turbidity,
                 y = mean_Conductivity,
                 color = mean_Conductivity), width = 1, height = 3) +
  scale_color_gradient(low = 'skyblue', high = 'orange')

```
Nothing of real interest here.
```{r}
coag_dose_df <- read_csv("CoagulantDoses_2017-20.csv")
head(coag_dose_df)

```
```{r}
#exploratory_df <- exploratory_df %>%
  #mutate(`dosing (exploratory)` = coag_dose_df$`Cationic Polimer, mg/L` )
length(exploratory_df) == length(coag_dose_df)
```
```{r}

coag_dose_df$Date <- mdy(coag_dose_df$Date)
ggplot(coag_dose_df) +
  geom_line(aes(x = Date,
                y = `Cationic Polimer, mg/L`))

```
```{r}
alk_df <- read_csv("alkalinity_hardness_cleaned.csv")
head(alk_df)

```
```{r}
alk_df$Date <- mdy(alk_df$Date)
ggplot(alk_df) +
  geom_line(aes(x = Date,
                y = alkalinity),
            color = 'orange') +
  geom_line(aes(x = Date,
                y = hardness),
            color = 'blue')
  
```
```{r}
generic_mlr <- linear_reg() |>
  set_mode("regression") |>
  set_engine("lm")

mlr_recipe <- recipe(alkalinity ~ hardness, data = alk_df)
mlr_wf <- workflow() |> 
  add_model(generic_mlr) |> 
  add_recipe(mlr_recipe)
fit(mlr_wf, data = alk_df)
```

```{r}
time_lag_1 <- 
time_lag_2 <- 
time_lag_3 <-

weekly_log_spec <- logistic_reg()
weekly_log_fit <- weekly_log_spec |>
  fit(Direction ~ Lag1 + 
      Lag2, 
      family = "binomial", 
      data = Weekly)
weekly_log_fit |>
  pluck("fit") |>
  summary()


```

```{r}
cross_validation <- initial_split(exploratory_df, prop = 0.6)
exploratory_train <- training(cross_validation)
exploratory_test <- testing(cross_validation)
#OPTION 1:
linear_recipe <- recipe(`pH SU` ~ `Temperature deg C`, data = exploratory_df)
quad_recipe <- linear_recipe |> step_mutate(`Temperature deg C_2` = `Temperature deg C`^2)
cubic_recipe <- quad_recipe |> step_mutate(`Temperature deg C_3` = `Temperature deg C`^3)
quart_recipe <- cubic_recipe |> step_mutate(`Temperature deg C_4` = `Temperature deg C`^4)
#OPTION 2:
linear_recipe <- recipe(`pH SU` ~ ., data = exploratory_df)
quad_recipe <- linear_recipe |> step_poly(all_numeric_predictors(), degree = 2)
cubic_recipe <- quad_recipe |> step_poly(all_numeric_predictors(), degree = 3)
quart_recipe <- cubic_recipe |> step_poly(all_numeric_predictors(), degree = 4)

loocv_df <- loo_cv(dfi)
test_errors <- data.frame()

retrieve_test_error <- function(least_sqrs_model, testing_set) {
  augment(least_sqrs_model, new_data = testing_set) |>
    mutate(resid2 = .resid^2) |> 
    summarise(rmse = sqrt(mean(resid2))) |>
    pull(rmse)
}

for (i in seq_len(nrow(loocv_df))) {
  train_data = training(loocv_df[i,]$splits[[1]])
  test_data = testing(loocv_df[i,]$splits[[1]])
  
  Y1 <- workflow() |> add_model(lstSqrs_spec) |> add_recipe(linear_recipe) |> fit(train_data)
  Y2 <- workflow() |> add_model(lstSqrs_spec) |> add_recipe(quad_recipe) |> fit(train_data)
  Y3 <- workflow() |> add_model(lstSqrs_spec) |> add_recipe(cubic_recipe) |> fit(train_data)
  Y4 <- workflow() |> add_model(lstSqrs_spec) |> add_recipe(quart_recipe) |> fit(train_data)
 
  data.frame(model = c("linear", "quadratic", "cubic", "quartic"),
             rmse = c(retrieve_test_error(Y1, test_data), 
                   retrieve_test_error(Y2, test_data), 
                   retrieve_test_error(Y3, test_data), 
                   retrieve_test_error(Y4, test_data)),
             i = i) |>
    rbind(test_errors) -> test_errors

}
test_errors |> 
  group_by(model) |>
  summarise(rmse = sqrt(mean(rmse))) |>
  kable()

```

```{r}
ggplot(exploratory_df) +
  geom_point(aes(x = mean_pH,
                 y = mean_Temp))
```
```{r}
RWAR_dosing_lag_incdec <- read_csv("RWAR_dosing_lag_incdec.csv")
head(RWAR_dosing_lag_incdec)

```
```{r}
RWAR_dosing_lag_incdec <- RWAR_dosing_lag_incdec %>%
  select(-c(FeCl_change, Polymer_change, Timestamp))
head(RWAR_dosing_lag_incdec)
```


```{r}
library(mgcv)

lm_spec <- linear_reg()

gam_formula <- Ferric.chloride..mg.L ~ s(Cationic.Polimer..mg.L) + s(mean_Temp) + s(mean_pH) + s(mean_Conductivity) + s(mean_Turbidity) + s(Temp_lag1) + s(Temp_lag2) + s(pH_lag1) + s(pH_lag2) + s(Cond_lag1) + s(Cond_lag2) + s(Turb_lag1) + s(Turb_lag2)

gam_fit <- gam(gam_formula, data = RWAR_dosing_lag_incdec)
gam_rec <- recipe(Ferric.chloride..mg.L ~ ., data = RWAR_dosing_lag_incdec) %>%
  step_ns(Cationic.Polimer..mg.L, deg_free = 10) %>%
  step_ns(mean_Temp, deg_free = 10) %>%
  step_ns(mean_pH, deg_free = 10) %>%
  step_ns(mean_Conductivity, deg_free = 10) %>%
  step_ns(mean_Turbidity, deg_free = 10) %>%
  step_ns(Temp_lag1, deg_free = 10) %>%
  step_ns(Temp_lag2, deg_free = 10) %>%
  step_ns(pH_lag1, deg_free = 10) %>%
  step_ns(pH_lag2, deg_free = 10) %>%
  step_ns(Cond_lag1, deg_free = 10) %>%
  step_ns(Cond_lag2, deg_free = 10) %>%
  step_ns(Turb_lag1, deg_free = 10) %>%
  step_ns(Turb_lag2, deg_free = 10)
  

gam_wf <- workflow() |>
  add_model(lm_spec) |>
  add_recipe(gam_rec)

gam_fit <- gam_wf |>
  fit(data = RWAR_dosing_lag_incdec)

gam_fit |> tidy()
gam_fit |> glance()

dat_grid <- tibble(expand.grid(Cationic.Polimer..mg.L = seq(min(RWAR_dosing_lag_incdec$Cationic.Polimer..mg.L), 
                               max(RWAR_dosing_lag_incdec$Cationic.Polimer..mg.L)),
                               mean_Temp = seq(min(RWAR_dosing_lag_incdec$mean_Temp), max(RWAR_dosing_lag_incdec$mean_Temp)),
                               mean_pH = seq(min(RWAR_dosing_lag_incdec$mean_pH), max(RWAR_dosing_lag_incdec$mean_pH)),
                               mean_Conductivity = seq(min(RWAR_dosing_lag_incdec$mean_Conductivity), max(RWAR_dosing_lag_incdec$mean_Conductivity)),
                               mean_Turbidity = seq(min(RWAR_dosing_lag_incdec$mean_Turbidity), max(RWAR_dosing_lag_incdec$mean_Turbidity)),
                               Temp_lag1 = seq(min(RWAR_dosing_lag_incdec$Temp_lag1), max(RWAR_dosing_lag_incdec$Temp_lag1)),
                               Temp_lag2 = seq(min(RWAR_dosing_lag_incdec$Temp_lag2), max(RWAR_dosing_lag_incdec$Temp_lag2)),
                               pH_lag1 = seq(min(RWAR_dosing_lag_incdec$pH_lag1), max(RWAR_dosing_lag_incdec$pH_lag1)),
                               pH_lag2 = seq(min(RWAR_dosing_lag_incdec$pH_lag2), max(RWAR_dosing_lag_incdec$pH_lag2)),
                               Cond_lag1 = seq(min(RWAR_dosing_lag_incdec$Cond_lag1), max(RWAR_dosing_lag_incdec$Cond_lag1)),
                               Cond_lag2 = seq(min(RWAR_dosing_lag_incdec$Cond_lag2), max(RWAR_dosing_lag_incdec$Cond_lag2)),
                               Turb_lag1 = seq(min(RWAR_dosing_lag_incdec$Turb_lag1), max(RWAR_dosing_lag_incdec$Turb_lag1)),
                               Turb_lag2 = seq(min(RWAR_dosing_lag_incdec$Turb_lag2), max(RWAR_dosing_lag_incdec$Turb_lag2))
                               ))
bind_cols(
  augment(gam_fit, new_data = dat_grid),
  predict(gam_fit, new_data = dat_grid, type = "conf_int")
) -> dose_pred_gam

for(pred in c("age", "year", "education")) {
  pred_dat <- dose_pred_gam[, c(pred, ".pred", ".pred_lower", ".pred_upper")] |>
    group_by_at(pred) |>
    summarise(.pred = mean(.pred), .pred_lower = mean(.pred_lower), .pred_upper = mean(.pred_upper))
  dose_dat <- RWAR_dosing_lag_incdec[, c(pred, "Ferric.chloride..mg.L")]
  
  if(is.numeric(dose_dat |> pull(pred))) {
    p <- dose_dat |>
      ggplot() +
      geom_point(aes_string(pred, "wage"), alpha = .3) +
      geom_line(aes_string(pred, ".pred"), data = pred_dat, colour = "darkgreen") +
      geom_line(aes_string(pred, ".pred_lower"), data = pred_dat, colour = "darkgreen", lty = 2) +
      geom_line(aes_string(pred, ".pred_upper"), data = pred_dat, colour = "darkgreen", lty = 2)
  } else {
    p <- dose_dat |>
      ggplot() +
      geom_jitter(aes_string(pred, "wage"), alpha = .3) +
      geom_point(aes_string(pred, ".pred"), data = pred_dat, colour = "darkgreen") +
      geom_errorbar(aes_string(pred, ymin = ".pred_lower", ymax = ".pred_upper"), data = pred_dat, colour = "darkgreen")
  }
  print(p)
}

```





